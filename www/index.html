<html>
<head>
<title>Nodent ES7 to ES5 compiler</title>
<style>
block {
	width: 48%;
	height: 70%;
	display: inline-block;
}

textarea {
	width: 100%;
	height: 100%;
	-moz-tab-size: 4;
	tab-size: 4;
}

pre {
	height: 15%;
	position: relative;
	bottom: 0;
	border: 1px solid #888;
	overflow-x: scroll;
}

pre div:last-child {
	background-color: #eef;
	color: #337;
}

.options>* {
	margin-right: 6%;
	margin-top: .5em;
}

.errorlog {
	background-color: #fee !important;
	color: #733 !important;
}

.banner {
		position: fixed;
		right: -1.5em;
		top: 2.5em;
		transform: rotate(45deg);
		width: 10em;
		z-index: 2;
		font-size: 0.9em;
		text-align: center;
		background-color: white;
		border: 1px solid #ccc;
		border-radius: 0.5em;
		padding: 0.5em;
}

#es5,#source {
	width:100%;
	height: 100%;
	border: 1px solid #ccc;
}

</style>
<script src="http://cdn.jsdelivr.net/bluebird/latest/bluebird.js"></script>
<script src="http://ajaxorg.github.io/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="source-map.js"></script>
<script>
	var sm, ui = {};

	function breathe() {
		return function($return,$error){
			setTimeout(function(){
				return $return(0)
			},0);
		}.$asyncbind(this) ;
	}

	Function.prototype.$asyncbind = <@$asyncbind@>;
	Function.prototype.$asyncspawn = <@$asyncspawn@>;

	function log() {
		var line = document.createElement("div");
		line.textContent = Array.prototype.slice.call(arguments).join(",")+ "\n";
		ui.log.appendChild(line);
		while (ui.log.children.length > 32)
			ui.log.removeChild(ui.log.children[0]);
		line.scrollIntoView(false);
		return line ;
	}
	function clearLog() {
			ui.log.innerHTML = "" ;
	}

	$error = function() {
		log.apply(this,arguments).className = "errorlog" ;
	}

	console.log = log;
	console.error = $error ;

	function http(method,url,data) {
		return function(resolve,reject) {
		    var xhr = new XMLHttpRequest() ;
		    xhr.onload = function(){
		    	try {
			        if (xhr.status>=400)
			        	throw new Error(xhr.responseText) ;
			        return resolve(JSON.parse(xhr.responseText)) ;
		    	} catch (ex) {
		    		return reject(ex) ;
		    	}
		    }
		    xhr.open(method,url,true) ;
		    xhr.send(data) ;
		}
	}

	function compile() {
		var src = source.value;
		if (!src)
			return;
		window.location.hash = encodeURIComponent(src);

		var ref = ui.impl[ui.impl.selectedIndex].value ;
		http("POST", ref, src)(function(resp){
//			source.value = resp.pretty;
			es5.value = resp.compiled;
			sm = new window.sourceMap.SourceMapConsumer(resp.map) ;
			if (resp.message)
				console.error(resp.message) ;
		},console.error) ;
	}

	function pretty() {
		var src = source.value;
		if (!src)
			return;
		window.location.hash = encodeURIComponent(src);

		var ref = ui.impl[ui.impl.selectedIndex].value ;
		http("POST", ref, src)(function(resp){
			source.value = resp.pretty;
			if (resp.message)
				console.error(resp.message) ;
		},console.error) ;
	}

	function execute() {
		try {
			(new Function(es5.value))();
		} catch (ex) {
			$error(ex);
		}
	}

	function loadExample() {
		var ref = ui.examples[ui.examples.selectedIndex].value ;
		if (ref) {
			http("GET",ref)(function(code){
				source.value = (code) ;
			}) ;
		}
	}

	window.onload = function() {
		// UI elements
		Array.prototype.forEach.call(document.getElementsByTagName("*"),
				function(e) {
					if (e.id)
						ui[e.id] = e;
				});

		// Double decode as NPMJS makes a mess of URLs in links
		if (window.location.hash)
			source.value = (decodeURIComponent(decodeURIComponent(window.location.hash.substring(1))));

		try {
			var temp = (new Promise(function() {})) && true;
    		var option = document.createElement("option") ;
    		option.value = "/promise" ;
    		option.textContent = "Use Promises" ;
    		option.selected = true ;
    		ui.impl.appendChild(option) ;

    		temp = eval("function *gen(){}") ;
        	option = document.createElement("option") ;
        	option.value = "/generators" ;
        	option.textContent = "Use Promises/Generators" ;
        	ui.impl.appendChild(option) ;
    	} catch (ex) { }

		http("get","/examples")(function(examples){
        	examples.forEach(function(fn){
        		var option = document.createElement("option") ;
        		option.value = fn ;
        		option.textContent = fn.split("/").pop() ;
        		ui.examples.appendChild(option) ;
        	}) ;
		},console.error) ;
	}
</script>
</head>
<body>
	<h2>Nodent ES7 to ES5 compiler</h2>
	<div class="banner">
		Install me from <a href="https://www.npmjs.com/package/nodent">npmjs</a>.
		Fork me on <a href="https://github.com/MatAtBread/nodent">Github</a>.
	</div>

	<div>
		<block>
			<div>ES7 source</div>
			<div id="source">//ES7 code</div>
			<div class="options">
				<select id="examples" onchange="loadExample()"><option value="">Enter code above or select example</option></select>
				<select id="impl" onchange="compile()"><option selected value="/es7">Pure ES5</option></select>
				<button onclick="pretty()">Pretty</button>
				<button onclick="compile()">Compile</button>
			</div>
		</block>
		<block>
			<div>Compiled JS</div>
			<div id="es5"></div>
			<div class="options">
				<button onclick="execute()">Run compiled JavaScript</button>
				<button onclick="clearLog()">Clear log</button>
			</div>
		</block>
		<pre id="log"></pre>
	</div>
</body>

<script>
var superProto = {
	value:{
		get:function(){ return this.getValue() },
		set:function(text) {
			this.setValue(text);
			this.clearSelection();
		}
	}
};
function extEdit(id) {
	var e = ace.edit(id) ;
	e.setShowPrintMargin(false);
	return Object.create(e,superProto) ;
}
var es5 = extEdit("es5");
var source = extEdit("source");

function syncOutput() {
	if (sm && source.$isFocused) {
		var c = source.selection.getCursor();
		var g = sm.generatedPositionFor({source:'source.js',line:c.row+1,column:c.column}) ;
		if (g.line){
			es5.selection.clearSelection() ;
			es5.selection.moveCursorTo(g.line-1,g.column) ;
		}
	}
}

function syncSource() {
	if (sm  && es5.$isFocused) {
		var c = es5.selection.getCursor();
		var g = sm.originalPositionFor({line:c.row+1,column:c.column}) ;
		if (g.line) {
			source.selection.clearSelection() ;
			source.selection.moveCursorTo(g.line-1,g.column) ;
		}
	}
}

source.getSession().selection.on('changeCursor',syncOutput);
es5.getSession().selection.on('changeCursor',syncSource);
es5.getSession().setMode("ace/mode/javascript");
</script>
</html>
