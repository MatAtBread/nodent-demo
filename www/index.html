<html>
<head>
<title>Nodent ES7 to ES5 compiler</title>
<style>
span {
  width:48%;
  height:70%;
  display: inline-block;
}
textarea {
  width:100%;
  height:100%;
}
pre {
  height: 15%;
  position: relative;
  bottom: 0;
  border: 1px solid #888;
  overflow-x: scroll;
}
pre div:last-child {
  background-color: #ddf;
  color: #448;
}
</style>
<script>
var ui = {} ;

Function.prototype.$asyncbind = function(self,catcher) {
	var fn = this ;
	fn.isAsync = true ;
	return function(){
		try {
			return fn.apply(self,arguments);
		} catch (ex) {
			catcher(ex);
		}
	} ; 
}

function $error(ex) {
  alert("Unhandled error: "+ex.toString()) ;
}

function log() {
  var line = document.createElement("div") ;
  line.innerText = line.textContent = Array.prototype.slice.call(arguments).join(",")+"\n" ; 
  ui.log.appendChild(line) ;
  while (ui.log.children.length>10)
    ui.log.removeChild(ui.log.children[0]) ;
  line.scrollIntoView(false) ;
}
console.log = log ;

function compile() {
  var src = ui.source.value ;
  if (!src)
    return ;
  window.location.hash = encodeURIComponent(src) ;	

  var xhr = new XMLHttpRequest() ;
  xhr.open("POST",ui.promise.checked?"/promise":"/es7",true) ;
  xhr.onreadystatechange = function(){
    if (xhr.readyState==4) {
      if (xhr.status!=200) {
        log(xhr.status+": "+xhr.responseText);
        return ;
      }
      try {
  	var resp = JSON.parse(xhr.responseText) ;
        ui.es5.value = resp.compiled ;
        if (resp.message)
          log(resp.message) ;
      } catch (ex) {
        log(ex.message) ;
      }
    }
  };
  xhr.send(src) ;
}

function execute() {
  try {
    (new Function(ui.es5.value))() ;
  } catch (ex) {
    log(ex.message) ;
  }  
}

window.onload = function() {
  // UI elements
  Array.prototype.forEach.call(document.getElementsByTagName("*"),function(e){ 
    if (e.id) ui[e.id] = e ;
  }) ;

  // Double decode as NPMJS makes a mess of URLs in links
  if (window.location.hash)
    ui.source.value = decodeURIComponent(decodeURIComponent(window.location.hash.substring(1))) ;

  try {
    ui.promise.checked = (new Promise(function(){})) && true ;
  } catch (ex) {
    // No Promises
    ui.promise.disabled = true ;     
  }	
}

</script>
</head>
<body>
<h2>Nodent ES7 to ES5 compiler</h2>
Install me from <a href="https://www.npmjs.com/package/nodent">npmjs</a>.
Fork me on <a href="https://github.com/MatAtBread/nodent">Github</a>.
</div>

<div>
<span>
<textarea id="source">
//ES7 code
</textarea>
<div><button onclick="compile()">Compile</button>
<input type="checkbox" id="promise">Use Promises</div>
</span>
<span>
<textarea id="es5"></textarea>
<div><button onclick="execute()">Run compiled JavaScript</button></div>
</span>
<pre id="log"></pre>
</div>
</body>
</html>
